# 发布 / 灰度 / 回滚 Runbook（模板）

目标：把上线过程“操作化”，避免关键时刻靠记忆与口头沟通。

> 说明：该 Runbook 同时适用于“新小程序替换旧小程序”和“同小程序内开关切换”两种策略；具体以 `decision-log.md` 中的 D005 为准。

---

## 1. 发布前置条件（不满足则禁止发布）
- [ ] 主分支 CI 全绿（lint / 单测 / 构建检查）
- [ ] 本次版本变更范围与里程碑一致（无未评审的范围漂移）
- [ ] `risk-register.csv` 中 High 风险已给出明确应对动作且无“逾期未处理”
- [ ] P0 链路用例回归完成并签字（登录/领券/支付/退款/核销）
- [ ] 线上监控看板可用（请求成功率、业务错误码、支付成功率、崩溃率）
- [ ] 发布负责人/回滚负责人已明确（不能同一人“既当裁判又当运动员”）

---

## 2. 版本与配置检查
- [ ] 版本号策略统一（例如：`major.minor.patch` + 构建号）
- [ ] 多环境配置已确认：dev/test/prod 的 baseURL、静态资源域名、埋点上报地址（见 `env-config.md`）
- [ ] 微信“request 合法域名 / uploadFile / downloadFile / websocket”白名单已配置并已验证
- [ ] 隐私合规配置与提示文案已确认（`requiredPrivateInfos`、授权弹窗等）

---

## 3. 上传体验版（开发者工具）
- [ ] 使用固定构建机器/固定 Node 版本（避免构建不可复现）
- [ ] 构建并上传体验版（填写版本号与变更说明）
- [ ] 体验版验证（至少 P0 链路 + 2 个异常场景）

产物留档：
- 体验版版本号：
- 体验版二维码：
- 验证人/时间：

---

## 4. 提交审核与发布
- [ ] 提交审核前再跑一遍 P0 链路（避免“刚修完忘记自测”）
- [ ] 审核通过后选择发布策略：
  - A：**分阶段发布**（推荐，有条件则开启）
  - B：全量发布 + **远程开关**（必须具备一键回滚开关）

发布窗口建议：
- 避开高峰交易时段
- 保证发布后至少 2 小时有人值守

---

## 5. 灰度观察（发布后 0~2 小时关键窗口）
必须观察的指标（建议阈值在 M2 前确定）：
- 接口成功率、P95 耗时
- 业务错误码（尤其是登录态、券、订单、支付相关）
- 支付成功率/取消率/失败率
- 退款成功率/异常率
- JS 错误/崩溃率

如果触发阈值：
- [ ] 立即停止放量（若分阶段发布）
- [ ] 启用回滚策略（见第 6 节）
- [ ] 建立事故记录（时间线、影响范围、根因与修复动作）

---

## 6. 回滚策略（必须提前演练一次）

### 6.1 版本回滚（发布旧版本）
适用：新版本存在致命问题且无法通过开关快速止血。
- [ ] 在小程序后台回退到上一稳定版本
- [ ] 发布后重复执行“灰度观察指标”

### 6.2 开关回滚（同版本内切换）
适用：使用远程配置/开关控制新老页面或新功能入口。
- [ ] 关闭新入口/切回旧实现
- [ ] 验证关键链路恢复

> 开关回滚要求：开关必须“默认安全”，且关闭后无需重启小程序即可生效（或提示用户重启）。

---

## 7. 发布后复盘（T+1）
- [ ] 监控指标与投诉量复盘
- [ ] 本次发布的问题清单与根因分析
- [ ] 更新 `risk-register.csv`（新增/关闭风险）
- [ ] 更新 `decision-log.md`（若决策被验证不合理，记录替代决策）

