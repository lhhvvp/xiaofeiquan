# 微信小程序原生重构总计划（1:1 还原 + UI 优化 + 一次切换）

版本：`v1.0`  
日期：`2026-02-08`  
适用项目：`xfq-miniapp/mp-native`

---

## 1. 目标与强约束

### 1.1 最终目标
- 以旧版 `uni-app` 为行为基线，完成 `63` 个页面的原生化迁移。
- 对外接口、请求路径、参数、错误码、登录态语义保持一致。
- 页面在“信息架构与交互路径不变”的前提下做 UI 优化（视觉升级，不改业务流程）。
- 采用一次切换（非灰度）上线策略。

### 1.2 强约束（必须同时满足）
- 不允许边做边改接口契约；所有变更先走契约评审。
- 不允许未通过批次闸门的页面进入主分支。
- 不允许在发布窗口引入新需求。
- 不允许“部分切换”；仅支持整包一次切换。
- 不允许以“先上线再修”替代缺陷闭环。

---

## 2. 基线现状（执行起点）

- 页面总量：`63`（来源：`xfq-miniapp/doc/migration-tracker.csv`）。
- 当前迁移状态：
  - `done=14`
  - `in_progress=17`
  - `ready_for_qa=18`
  - `todo=14`
- 当前 `mp-native` 含骨架页与占位页，不可视为“视觉 1:1 完成态”。

---

## 3. 范围定义

### 3.1 In Scope（本次必须完成）
- TabBar 四页：`index/merchant/tickets/user`
- 登录与授权：`login/getopenid`
- 优惠券、门票、订单、支付、退款、核销全链路
- 用户中心全模块（资料、收藏、评价、投诉、常用游客、预约、签到、任务）
- 团相关页面（GroupCoupon 系列）和尾页（`line*`、`travel*`、`list` 等）
- 全量样式对齐与视觉优化（含 tabBar 图标、导航视觉、卡片体系、空态/错误态）

### 3.2 Out of Scope（本次不做）
- 后端业务逻辑改造（除兼容修复外）
- 接口协议重设计
- 发布后再做大规模 UI 改版

---

## 4. UI 优化原则（与 1:1 并行）

- 结构不变：模块入口、信息层级、关键按钮位置不变。
- 行为不变：点击路径、跳转关系、校验顺序、提示语义不变。
- 视觉可优化：字体层级、间距、留白、卡片圆角、色板一致性、弱信息降噪。
- 可读性优先：关键动作按钮可见性高于装饰效果。
- 同步设计令牌：颜色、字号、间距、阴影、圆角全部沉淀为统一 token。

---

## 5. 执行组织与责任

### 5.1 角色
- 技术负责人：计划推进、范围控制、发布决策。
- 页面负责人：按批次交付页面与联调结果。
- QA 负责人：批次验收、回归签字、发布闸门签字。
- 发布负责人：一次切换窗口执行与回滚。

### 5.2 RACI（简化）
- 需求冻结：技术负责人 `A`，产品/业务 `C`，研发/QA `R`
- 批次开发：页面负责人 `R`，技术负责人 `A`
- 批次验收：QA `R`，技术负责人 `A`
- 发布决策：技术负责人 + QA + 业务三方 `A`

---

## 6. 里程碑与时间盒（强约束）

> 总周期建议：`8~10` 周（2 人研发 + 1 人 QA）；若单人执行建议 `12~14` 周。

### M0（第 1 周）：冻结与底座
- 冻结旧版行为基线（截图、录屏、关键链路结果）
- 冻结接口契约与配置矩阵
- 建立 UI token 与公共组件规范

### M1（第 2~3 周）：TabBar 与登录主链路
- 完成 `user/index/merchant/tickets/login/getopenid` 的 1:1 + UI 优化
- 完成 tabBar 图标、全局样式、导航视觉体系

### M2（第 4~6 周）：交易与用户中心
- 完成优惠券、门票、订单、支付、退款、核销链路
- 完成用户中心全模块页面迁移与联调

### M3（第 7~8 周）：尾页清零与全量回归
- 清零 `todo/in_progress` 页面
- 全量功能回归、视觉回归、弱网回归、兼容性回归

### M4（第 9~10 周）：发布准备与一次切换
- 版本冻结（仅允许 blocker 修复）
- Go/No-Go 评审
- 一次切换执行与上线观察

---

## 7. 批次策略（必须执行）

- 批次粒度：`1` 个核心入口页 + 相关子页，不跨业务域并行。
- 批次产物必须完整：代码、截图、录屏、接口比对、测试记录、缺陷闭环。
- 每个批次通过后才可进入下一批次。
- 批次状态定义：`planned -> in_progress -> dev_done -> qa_pass -> merged`。

---

## 8. 质量闸门（发布前必须全绿）

### G1 视觉闸门
- 关键页面与旧版结构一致，视觉优化符合 UI 规范。
- tabBar、导航栏、卡片、列表、空态、错误态统一。

### G2 交互闸门
- 核心流程可达：登录、领券、下单、支付、退款、核销、评价、投诉。
- 返回路径、重复点击保护、下拉刷新、分页行为正确。

### G3 契约闸门
- 请求路径、method、header、参数、错误码与旧版兼容。
- 无新增未评审接口；无破坏性字段变更。

### G4 稳定性闸门
- `npm run check` 通过。
- `npm run mock:smoke` 通过。
- 全量回归通过率 `100%`（P0/P1）。
- Blocker/Critical 缺陷 `0`。

### G5 发布闸门
- 版本冻结期无新增需求。
- Go/No-Go 评审签字完成。
- 回滚方案演练完成并可执行。

---

## 9. 一次切换发布方案（无灰度）

### 9.1 D-14 ~ D-7（准备）
- 完成全量回归与缺陷清零。
- 完成体验版验收与业务签字。
- 冻结依赖版本与构建环境。

### 9.2 D-6 ~ D-1（冻结）
- 仅允许 blocker 修复，禁止功能改动。
- 每日构建 + 每日全链路冒烟。
- 发布脚本、回滚脚本、联系人值班表确认。

### 9.3 D-Day（切换）
- 执行最终构建并上传正式包。
- 按 Runbook 执行发布。
- 发布后 `2` 小时高密度观测（接口错误率、支付成功率、JS 错误率）。

### 9.4 D+1 ~ D+3（稳态）
- 持续监控，关闭残余缺陷。
- 输出上线复盘报告。

---

## 10. 风险与应对

- 风险：一次切换失败影响面大  
  应对：严格冻结 + 预发布全回归 + 明确回滚阈值与负责人。

- 风险：UI 优化导致交互偏移  
  应对：先 1:1 结构对齐，再做样式增强；每批次都做交互回放。

- 风险：多页面并发改造引发回归爆炸  
  应对：单批次串行闸门，不跨域并行。

- 风险：接口兼容漂移  
  应对：契约清单化，联调前后自动比对。

---

## 11. 交付物清单

- 总计划：`xfq-miniapp/doc/native-1to1-master-plan.md`
- 批次执行单：`xfq-miniapp/doc/batch-execution-checklist.md`
- 页面跟踪：`xfq-miniapp/doc/migration-tracker.csv`
- 页面 DoD：`xfq-miniapp/doc/page-dod-checklist.md`
- 发布手册：`xfq-miniapp/doc/release-runbook.md`
- 冒烟用例：`xfq-miniapp/doc/m3-smoke-test.md`、`xfq-miniapp/doc/m4-smoke-test.md`

---

## 12. 完成定义（Definition of Complete）

- `63/63` 页面迁移完成并通过 QA。
- 视觉规范与 UI 优化落地，且核心页面无结构偏差。
- 核心业务链路全通过，接口兼容无破坏。
- 一次切换上线后稳定运行，无 blocker 级事故。
