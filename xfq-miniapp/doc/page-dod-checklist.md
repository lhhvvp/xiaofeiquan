# 页面迁移 DoD（Definition of Done）与验收清单

用于保证“原生重构”可按模块稳定交付，避免迁移到后期回归爆炸。

---

## 1. 基础能力 DoD（所有页面共享）

### 1.1 request（请求层）
- [ ] 所有接口调用必须通过 `services/request`（禁止在页面里直接 `wx.request`）
- [ ] Token/Userid 注入与旧 `uerInfo` 兼容读取通过
- [ ] 统一错误码策略已覆盖：未登录/登录过期/用户信息异常（对齐旧逻辑）
- [ ] Loading 策略可配置：全局 loading、静默请求、并发计数不抖动
- [ ] 超时/断网/非 200 状态码有明确提示与兜底
- [ ] 请求监控上报可用（耗时、状态码、业务错误码、关键接口）

### 1.2 auth（鉴权/路由守卫）
- [ ] `wx.login` -> 后端换 token 流程可用（包含失败重试与异常提示）
- [ ] 未登录跳转统一（保留原目标页/参数）
- [ ] “实名/补全信息”之类的二次门槛有统一判断与跳转（若业务需要）

### 1.3 cache（TTL 缓存）
- [ ] 支持 TTL、支持 namespace、支持一键清理
- [ ] 兼容旧 key（至少 `uerInfo`、`coord`）

### 1.4 monitor（可观测性）
- [ ] JS 错误（含 Promise 未捕获）可上报
- [ ] 关键链路埋点（登录/领券/支付/退款/核销）定义明确且落地

---

## 2. 单页面迁移 DoD（每个页面都要过）

### 2.1 结构与资源
- [ ] 页面路由已配置（主包/分包 root 正确）
- [ ] 页面标题/导航样式与旧版一致或有明确产品确认
- [ ] 依赖的组件已抽到 `components/` 且可复用（避免页面内复制粘贴）
- [ ] 图片/静态资源放到统一目录并可按需加载（避免主包膨胀）

### 2.2 业务逻辑
- [ ] 页面涉及的接口已归口到 `services/api/<module>`
- [ ] 参数校验与非法字符处理一致（旧版有 `hasIllegalChar` 等逻辑）
- [ ] 状态恢复：返回上一页/重新进入时行为一致（特别是订单/支付/核销页）
- [ ] 重复点击已防护（支付、提交表单、领券等）

### 2.3 体验与异常
- [ ] Loading/空态/错误态齐全（网络断开、无数据、接口失败）
- [ ] 下拉刷新/分页加载（旧版开启的页面必须对齐）
- [ ] Toast/Modal 文案一致或已确认
- [ ] 权限处理完善（定位授权失败要引导到设置）

### 2.4 数据一致性
- [ ] 关键数据的 storage key 与旧版兼容（避免升级后用户体验断层）
- [ ] 订单/支付相关字段对齐（金额、状态、时间格式、展示规则）

### 2.5 埋点与日志
- [ ] 页面曝光/点击埋点已补齐（至少覆盖旧版已有的关键上报点）
- [ ] 异常路径（接口失败、支付失败）有上报与可追踪日志

### 2.6 自测与提测
- [ ] 自测记录：覆盖“关键路径 + 2 个异常场景”
- [ ] 对照旧版：同账号/同数据下结果一致（截图或录屏留档）
- [ ] 提测后发现的问题已回归关闭

---

## 3. 高风险页面额外清单（必须加严）

### 3.1 支付/退款/订单相关
- [ ] 支付前置校验（库存/价格/订单状态）完整
- [ ] 支付失败/取消支付的状态回收正确（不会卡死或重复扣款）
- [ ] 支付成功后的落地页可从“微信支付结果回到小程序”正确恢复
- [ ] 退款/售后流程可重复进入且不会产生脏状态

### 3.2 定位/地图相关
- [ ] 首次拒绝定位后的引导流程可用
- [ ] 无定位时有降级（例如默认城市/提示用户开启定位）

### 3.3 二维码/核销相关
- [ ] 二维码刷新/过期策略与旧版一致
- [ ] 截屏/保存/分享行为符合业务与合规要求

