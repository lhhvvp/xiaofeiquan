# 关键决策记录（Decision Log）

目的：把“架构/工程化/上线策略”等关键选择写成可追溯的记录，避免重构期反复争论造成返工。

使用规则：
- 任何会影响 **工期、架构边界、全局约束、上线/回滚方案** 的事项，都必须写一条 Decision。
- 决策必须包含：上下文、候选方案、最终选择、代价/影响、执行动作与负责人。
- 决策一旦确认，只能通过新增一条“替代决策”来变更（禁止悄悄改口）。

---

## 决策清单（建议在 M0 结束前定稿）

| ID | 主题 | 截止里程碑 | 状态 | 负责人 |
|---|---|---|---|---|
| D001 | 是否启用 TypeScript（全量/分层） | M1 | 已定 |  |
| D002 | 全局状态方案（自建 store / MobX / 其它） | M1 | 已定 |  |
| D003 | UI 组件库选择（TDesign/Vant/自研）与风格约束 | M1 | 已定 |  |
| D004 | 分包方案定稿（主包最小集、各分包 root） | M1 | 已定 |  |
| D005 | 新旧切换方式（新小程序替换 / 同小程序开关） | M0 | 暂定 |  |
| D006 | 多环境策略（dev/test/prod）与域名白名单 | M0 | 暂定 |  |
| D007 | 监控与埋点方案（事件命名、上报通道、看板） | M1 | 已定 |  |
| D008 | 接口契约与 Mock 策略（Apifox/Swagger/本地 mock） | M1 | 已定 |  |
| D009 | 发布流程与回滚策略（分阶段发布/开关回滚） | M2 | TBD | TBD |
| D010 | 旧页面合并/废弃策略（例：`merchant/info/merchant`） | M2 | 已定 |  |

---

## 已确认决策（当前项目默认采用）

### D001 - TypeScript 策略（先 JS，后分层引入）
- **日期**：2026-02-05
- **背景/问题**：项目大但当前为单人推进，优先确保“可运行、可迁移、可联调”的节奏；同时减少工程化引入带来的摩擦。
- **候选方案**：
  - A：全量 TypeScript（页面 + services + utils）
  - B：分层 TypeScript（优先 `services/`、`utils/`，页面先 JS）
  - C：暂不引入 TypeScript（全 JS）
- **选择**：C（M1~M2 全 JS），M2 结束后复盘是否按 B 引入
- **理由**：避免 TS 工具链与构建配置成本；当前阶段更需要快速打通 P0 闭环。
- **落地动作**：
  - [ ] M2 封板后评估：是否把 `services/`、`utils/` 迁到 TS（按收益排序）

### D002 - 全局状态方案（不引入 Store）
- **日期**：2026-02-05
- **背景/问题**：旧工程使用 Vuex，但原生小程序阶段优先把公共能力收敛到 `services/`、`utils/`，页面保持轻量。
- **候选方案**：
  - A：自建轻量 store
  - B：`mobx-miniprogram`
  - C：不引入 store（storage + page state + services 缓存）
- **选择**：C
- **理由**：减少引入复杂度；对当前 P0 页面（列表/详情/登录）足够。
- **落地动作**：
  - [ ] 若出现跨页共享状态需求，再评估 B（优先）或 A

### D003 - UI 组件库（不引入第三方，先自建最小集）
- **日期**：2026-02-05
- **背景/问题**：第三方 UI 库会增加包体与升级成本；当前目标是功能等价与工程稳定。
- **候选方案**：
  - A：TDesign（微信小程序）
  - B：Vant Weapp
  - C：不引入第三方 UI 库，自建“空态/加载/弹窗/列表 item”等最小组件
- **选择**：C
- **落地动作**：
  - [ ] 在 M2 过程中按需补齐 `components/` 最小组件，并沉淀样式规范

### D004 - 分包方案（分包先行）
- **日期**：2026-02-05
- **选择**：按模块拆 `subpackages/*`，主包仅保留 tabBar + 登录等最小集
- **落地动作**：
  - [x] 已落地：`subpackages/coupon`、`subpackages/merchant`、`subpackages/tickets`

### D005 - 新旧切换方式（暂定：替换发布）
- **日期**：2026-02-05
- **候选方案**：
  - A：新原生工程最终替换旧工程发布（同 AppID，按版本灰度）
  - B：同一小程序内通过开关切换新旧页面（更稳，但工程复杂）
- **选择**：A（暂定）
- **理由**：当前新旧工程为独立目录，B 的改造成本高；先以“内部体验版→灰度→全量”控制风险。
- **落地动作**：
  - [ ] 每个里程碑发布前保留旧工程可回滚版本（tag/分支），并按 `release-runbook` 演练回滚

### D006 - 多环境与域名策略（默认 baseUrl 为空 + 本地覆盖）
- **日期**：2026-02-05
- **选择**：仓库内 `baseUrl` 默认空，联调通过 `miniprogram/config/local.js` 覆盖；`develop/trial/release` 暂以测试环境联调为主
- **落地动作**：
  - [x] 代码约定已落地：`mp-native/miniprogram/config/index.js` + `local.example.js`
  - [ ] 上线前补齐域名白名单清单与矩阵：`env-matrix.csv`

### D007 - 监控与埋点（沿用 wx.reportEvent）
- **日期**：2026-02-05
- **选择**：沿用旧工程 `wx.reportEvent('wxdata_perf_monitor', payload)` 作为请求与错误的基础监控通道
- **落地动作**：
  - [x] request 层耗时/错误上报
  - [x] `app.js` 全局 error/unhandledRejection 捕获上报

### D008 - 接口归口与 Mock（先归口，不引入重型 Mock）
- **日期**：2026-02-05
- **选择**：接口统一归口到 `services/api/*`；不引入重型 Mock 工具，优先通过测试环境联调与本地 `baseUrl` 覆盖
- **落地动作**：
  - [x] 已开始按模块拆分：`services/api/coupon|merchant|tickets`

### D010 - 旧页面合并：`merchant/info/merchant` 不单独迁移
- **日期**：2026-02-05
- **背景/问题**：旧工程存在 `pages/merchant/info/info` 与 `pages/merchant/info/merchant` 两个相近页面，后者仅展示营业时间/电话/地址/介绍等信息，易造成原生重构重复实现与后续维护分叉。
- **候选方案**：
  - A：原样迁移 `merchant/info/merchant`（新增一个原生页面）
  - B：合并到 `merchant/info/info`，不再单独迁移
  - C：删除相关能力（若确认线上无入口）
- **选择**：B
- **理由**：减少页面数量与重复代码；保留业务信息展示能力；把“商家详情”收敛到一个来源。
- **影响范围**：迁移跟踪表与后续验收以 `pages/merchant/info/info` 为准。
- **落地动作**：
  - [x] `migration-tracker.csv` 标记为“合并迁移”并随 `merchant/info/info` 一起验收

## Decision 模板（复制后填写）

### DXXX - <主题>
- **日期**：YYYY-MM-DD
- **背景/问题**：
- **约束**（团队、时间、合规、平台限制等）：
- **候选方案**：
  - A：
  - B：
  - C（可选）：
- **选择**：A / B / C
- **理由**（必须写清楚取舍）：
- **影响范围**（代码目录、已有模块、上线/回滚、人员分工）：
- **落地动作**（可执行清单）：
  - [ ] 动作 1（Owner，截止时间）
  - [ ] 动作 2（Owner，截止时间）
- **复盘点**（何时验证该决策正确）：
