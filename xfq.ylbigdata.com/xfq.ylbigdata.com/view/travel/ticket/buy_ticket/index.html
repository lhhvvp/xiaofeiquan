<div id="app" class="p-4">
    <div class="row" v-if="!pageLoading" >
        <div class="col-md-3 scenic-box">
            <div class="card card-primary card-outline">
                <div class="card-header">
                    <h3 class="card-title">景区列表</h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm">
                            <input type="text" v-model="searchInput" class="form-control" placeholder="搜索景区">
                            <div class="input-group-append">
                                <div class="btn btn-primary" v-on:click="searchScenic">
                                    <i class="fas fa-search"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="media border-bottom p-2" :class="{'bg-light':scenic_index === index}" v-for="(item,index) in scenic_list">
                        <img :src="item.image" width="80" height="70" class="mr-3">
                        <div class="media-body">
                            <div class="mt-0">{{item.nickname}}</div>
                            <div>{{item.area_text}}</div>
                            <div>门票：<b class="text-red">￥{{item.min_price}}</b>起 <button type="button" v-on:click="changeScenic(index)"
                                                              class="btn btn-xs bg-teal float-right">选择景区</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9 ticket-box" >
            <h5 v-if="scenic_index === ''">请选择景区</h5>
            <h5 v-else-if="ticket_list.length == 0">该景区暂无门票</h5>
            <div class="card card-primary card-outline" v-if="ticket_list.length > 0">
                <div class="card-body">
                    <div  v-for="(item,index) in ticket_list">
                        <h4>{{item.title}}</h4>
                        <div class="row" v-if="item['ticket_list'].length > 0">
                            <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch flex-column"
                                 v-for="(val,key) in item['ticket_list']"
                                 :key="val.id">
                                <div class="card bg-light d-flex flex-fill">
                                    <div class="card-header text-muted border-bottom-0">{{val.title}}</div>
                                    <div class="card-body px-3 pb-3 pt-0">
                                        <div>
                                            <b>使用说明：</b>
                                            <a class="text-blue" href="javascript:;" v-on:click="openModal(index,key,'explain_use')">点击查看</a>
                                        </div>
                                        <div>
                                            <b>购买说明：</b>
                                            <a class="text-blue" href="javascript:;" v-on:click="openModal(index,key,'explain_buy')">点击查看</a>
                                        </div>
                                        <div v-if="val.rights_num>0">
                                            <b>核销说明：</b>
                                            <a class="text-blue" href="javascript:;" v-on:click="openModal(index,key,'rights')">点击查看</a>
                                        </div>
                                    </div>
                                    <div class="card-footer d-flex align-items-center">
                                        <div>
                                            <b style="font-size: 22px" class="mr-2 text-red fs-32">{{val.min_price}}起</b>
                                            <span style="text-decoration: line-through;">{{val.crossed_price}}</span>
                                        </div>
                                        <div class="ml-auto">
                                            <button type="button" class="btn btn-xs bg-teal" v-on:click="openBuyModal(index,key)">
                                                <i class="fa fa-shopping-cart"></i> 立即购买
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" :style="explain_modal ? {'display': 'block'} : {}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">查看说明</h5>
                    <button type="button" class="close" v-on:click="closeExplainModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" >
                    <article v-html="modal_html">
                    </article>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" v-on:click="closeExplainModal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <!--购买门票 -->
    <div class="modal" :style="buy_modal ? {'display': 'block'} : {}" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" v-if=" ticket_index!=='' ">购买 "{{ticket_list[ticket_index]['title']}}" 门票</h5>
                    <button type="button" class="close" v-on:click="closeBuyModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" >
                    <div v-if="ticket_price.length > 0" class="d-flex flex-wrap align-items-center overflow-auto" style="height:220px;">
                       <div  style="width:110px;cursor:pointer;" :class="{'bg-success text-white':date_index===index}" v-on:click="selectedDate(index)" class="m-2 rounded border border-light p-2 text-center" v-for="(item,index) in ticket_price">
                           <div><b>{{item.date}}</b></div>
                           <div>余{{item.stock}} ￥{{item.price}}</div>
                       </div>
                    </div>
                    <div v-else class="d-flex align-items-center justify-content-center">
                        <h5 class="my-4 text-center">该门票暂无售价</h5>
                    </div>
                    <div class="table-responsive  mt-3" style="max-height:350px;">
                    <table class="table table-striped table-head-fixed fixed-table-footer fixed-table-header">
                        <thead>
                        <tr>
                            <th>序号</th>
                            <th>游客姓名</th>
                            <th>证件类型</th>
                            <th>证件号</th>
                            <th>手机号</th>
                            <th>验证</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody >
                            <tr v-for="(item,index) in tourist_list">
                                <td>{{ index+1 }}</td>
                                <td>{{item.fullname}}</td>
                                <td>{{item.cert_type}}</td>
                                <td>{{item.cert_id}}</td>
                                <td>{{item.mobile}}</td>
                                <td>
                                    <span class="badge" :class="item.auth == 1 ? 'badge-success' : 'badge-danger'">{{item.auth_msg}}</span>
                                </td>
                                <td><button class="btn btn-xs btn-danger" v-on:click="deleteTourist(index)"><i class="fa fa-trash-alt"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
                    <div class="buy-info">
                        <div class="tourist-meta mb-3">
                            <input type="file" ref="fileImportTourist" @change="handleFileUpload" style="display: none;"><button v-on:click="importTourist" class="btn btn-warning btn-sm">导入游客</button>
                            <a href="/static/travel/导入游客模板.xlsx" target="_blank" class="btn ml-2"><i class="fa fa-download"></i>下载导入游客模板</a>
                            <button v-on:click="checkTourist" class="btn btn-info btn-sm ml-3">一键验证游客信息</button>
                        </div>
                        <h6>订单备注</h6>
                        <textarea class="form-control" v-model="order_remark"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="mr-3">
                      <span v-if="date_index !== ''">日期：<b style="font-size: 20px;">{{ ticket_price[date_index]['date']}}</b> <span class="ml-2">单价：<b class="text-red" style="font-size: 20px;">{{ ticket_price[date_index]['price']}}</b></span></span>
                        <span class="ml-3" v-if="tourist_list.length > 0">游客：x <b style="font-size: 20px;">{{ tourist_list.length}}</b> 位</span>
                        <span class="ml-3">合计：<b class="text-red " style="font-size: 20px;">￥{{total_price}}</b></span>
                    </div>
                    <button type="button" class="btn btn-success" v-on:click="doBuy">立即预定</button>
                </div>
            </div>
        </div>
    </div>


    <div v-if="explain_modal||buy_modal" class="modal-backdrop fade" :class="{'show':explain_modal||buy_modal}"></div>
</div>
<script src="/static/plugins/vue2/vue.js"></script>
<script type="text/javascript">
    $(function() {
    var app = new Vue({
        el: '#app',
        data: {
            pageLoading: true,
            searchInput:"",
            scenic_index:"",
            scenic_list: [],
            ticket_list: [],
            ticket_price:[],
            search_scenic_keywords: "",
            explain_modal:false,
            ticket_index:"",
            ticket_key:"",
            buy_modal:false,
            modal_html:"",
            date_index:"",
            tourist_list:[],
            total_price:0,
            order_remark:""
        },
        created:function(){
            let that = this;
            this.getPage();
        },
        watch:{
            date_index(newValue, oldValue) {
                this.countTotalPirce();
            },
            tourist_list(newValue,oldValue){
                this.countTotalPirce();
            }
        },
        methods: {
            countTotalPirce(){
                let number = this.tourist_list.length;
                let price = this.date_index === "" ? 0 : this.ticket_price[this.date_index]['price'];
                this.total_price = price*number;
            },
            getPage(){
                this.getScenicList();
                this.pageLoading = false;
            },
            async getScenicList(){
                let that = this;
                try {
                    const response = await ajaxRequest('api/ticket/getScenicList', 'GET', { keywords: this.searchInput,'hasTicket':true,'pageSize':10000});
                    that.scenic_list = response.data;
                    // 处理成功的响应数据
                } catch (error) {
                    console.error(error);
                    // 处理错误
                }
            },
            async getTicketList(){
                let that = this;
                let seller_id = this.scenic_list[this.scenic_index]['id'];
                try {
                    const response = await ajaxRequest('api/ticket/getTicketList', 'GET', { seller_id:seller_id });
                    that.ticket_list = response.data;
                    // 处理成功的响应数据
                } catch (error) {
                    console.error(error);
                    // 处理错误
                }
            },
            async getPrice(){
                //获取门票价格
                let that = this;
                let ticket_id = this.ticket_list[this.ticket_index]['ticket_list'][this.ticket_key]['id'];
                try {
                    const response = await ajaxRequest('api/ticket/getTicketPirce', 'GET', { ticket_id:ticket_id,channel:'team' });
                    that.ticket_price = response.data;
                    // 处理成功的响应数据
                } catch (error) {
                    console.error(error);
                    // 处理错误
                }
            },
            changeScenic(index) {
                this.scenic_index = index;
                this.getTicketList();
            },
            searchScenic(){
                if(this.searchInput.length > 0){
                    this.getScenicList();
                }
            },
            openModal(index,key,field){
                if(field == 'rights'){
                    let rights_list = this.ticket_list[index]['ticket_list'][key]["rights_list"];
                    let html = `<p>该门票包含（`;
                    for (var i = 0; i < rights_list.length; i++) {
                        console.log(rights_list[i]);

                        if(i == 0){
                            html+= `${rights_list[i]['title']}`;
                        }else{
                            html+= `、${rights_list[i]['title']}`;
                        }
                    }
                    html+= `)</p><p>请前往对应核销点进行核销</p>`;
                    this.modal_html = html;
                }else{
                    this.modal_html = this.ticket_list[index]['ticket_list'][key][field];
                }

                this.explain_modal = true;
            },
            closeExplainModal(){
                this.explain_modal = false;
            },
            closeBuyModal(){
                this.buy_modal = false;
            },
            openBuyModal(index,key){
                this.ticket_index = index;
                this.ticket_key = key;
                this.buy_modal = true;
                this.date_index = "";
                this.getPrice();
            },
            selectedDate(index){

                if(index === this.date_index){
                    this.date_index = "";
                }else{
                    this.date_index = index;
                }

            },
            importTourist(){
                this.$refs.fileImportTourist.click();
            },
            async checkTourist(){
                let that = this;
                if(this.tourist_list.length < 1){
                    layer.msg("请先导入游客！");
                    return;
                }
                let check_tourist_list = [];
                for (let item of this.tourist_list) {
                    if(item.auth == 0){
                        check_tourist_list.push(item)
                    }
                }
                if(check_tourist_list.length < 1){
                    layer.msg("不存在待验证的游客！");
                    return;
                }
                try{
                    let result = await ajaxRequest("travel/ticket.BuyTicket/checkTourist","POST",{tourist_list: check_tourist_list});
                    console.log(result);
                    let o_tourist_list = that.tourist_list;
                    console.log(o_tourist_list);
                    let c_tourist_list = result.data;
                    let n_tourist_list = [];
                    for (var i = 0; i < o_tourist_list.length; i++) {
                        n_tourist_list[i] = o_tourist_list[j];
                        if(o_tourist_list[i]['auth'] != 1){
                            for (var j = 0; j < c_tourist_list.length; j++) {
                                if (o_tourist_list[i].cert_id === c_tourist_list[j].cert_id) {
                                    n_tourist_list[i] = c_tourist_list[j];
                                    break; // 找到匹配的元素后跳出内层循环
                                }
                            }
                        }
                    }
                    that.tourist_list = n_tourist_list;
                    toastr.info("一键验证完成，请查看游客列表提示信息！");
                }catch(err){
                    console.log(err)
                }
            },
            async handleFileUpload(event){
                let that = this;
                const file = event.target.files[0];
                let formData = new FormData();
                formData.append('file', file);
                try{
                   let result = await ajaxRequest("travel/ticket.BuyTicket/readImportTourist","POST",formData,{processData: false, contentType: false});
                   that.tourist_list =  [...that.tourist_list, ...result.data];

                }catch(err){
                    console.log(err)
                }
                this.$refs.fileImportTourist.value = "";
            },
            deleteTourist(index){
                //删除游客
                tourist_list = this.tourist_list
                tourist_list.splice(index, 1);
            },
            async doBuy(){
                let formData = {};
                if(this.date_index === ""){
                    layer.msg("请选择日期");
                    return;
                }
                if(this.tourist_list.length < 1 ){
                    layer.msg("请导入游客");
                    return;
                }
                for(let item of this.tourist_list){
                    if(item.auth != 1){
                        layer.msg("有未验证通过的游客，请删除后再试！");
                        return;
                    }
                }
                formData.tourist_list = this.tourist_list;
                formData.date = this.ticket_price[this.date_index]['date'];
                formData.ticket_id = this.ticket_price[this.date_index]['ticket_id'];
                formData.total_price = this.total_price;
                formData.order_remark = this.order_remark;
                try{
                    let result = await ajaxRequest("travel/ticket.BuyTicket/createOrder","POST",formData,{},true);
                    if(result.code == 1){
                        //清空数据
                        this.tourist_list = [];
                        this.date_index = "";
                        //成功,显示二维码
                        layer.open({
                            title:"下单成功",
                            type: 1,
                            area: ["300px","370px"], // 宽高
                            content: `<div class="text-center p-3"><img src="${result.data}" width="240" /><p class="mt-3">请使用微信扫一扫进行支付</p></div>`
                        });
                        this.buy_modal = false;
                    }else{
                        layer.msg(result.msg);
                        return;
                    }
                }catch(err){
                    console.log(err)
                }
            }
        }
    })
    function ajaxRequest(url, method, data,option={},showLoading=false) {

        let fullUrl = "{$Request.domain}/"+url;
        let loading = null;
        if(showLoading){
            loading =  layer.load(0, {shade: true})
        }
        return new Promise(function(resolve, reject) {
            let options = {
                url: fullUrl,
                method: method,
                data: data,
                success: function(response) {
                    resolve(response);
                },
                error: function(error) {
                    reject(error);
                },
                complete:function(e){
                    if(loading !== null){
                        layer.close(loading);
                    }
                }
            };
            options = $.extend({}, options, option);
            $.ajax(options);
        });
    }
    });
</script>
