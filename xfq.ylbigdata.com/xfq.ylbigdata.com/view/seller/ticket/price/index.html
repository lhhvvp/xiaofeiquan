<section class="content">
    <!--顶部提示开始-->
    <!--顶部提示结束-->
    <div class="container-fluid">
        <div>
            <h2>票种：“{$ticket['title']}”  价格</h2>
            <button class="btn btn-primary btn-sm" onclick="openCreatePrice()">生成价格</button>
        </div>
        <div id='calendar'></div>
    </div>
</section>
<script src="/static/plugins/fullcalendar/index.global.min.js"></script>
<!--<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>-->
<script>
    function openCreatePrice(){
        var url = "{:url('seller/ticket.price/build')}?ticket_id={$ticket['id']}&_layer=1";
        $.modal.open('生成价格',url,800,500);
    }
    var events = {:json_encode($list,true)};
    var calendar = null;
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'zh-cn',
            dayMaxEventRows: true, // for all non-TimeGrid views
            views: {
                timeGrid: {
                    dayMaxEventRows: 1 // adjust to 6 only for timeGridWeek/timeGridDay
                }
            },
            buttonText: {
                today: '今天',
                month: '月',
                week: '周',
                dayGrid: '日'
            },
            firstDay: 1,
            initialView: 'dayGridMonth',
            events: function(fetchInfo, successCallback, failureCallback) {
                console.log(fetchInfo);
                // 在这里编写获取事件数据的逻辑
                // 可以使用 AJAX 请求、从数据库查询等方式获取数据
                let start = formattedDate( fetchInfo.start),end = formattedDate( fetchInfo.end);
                $.ajax({
                    url:"{:url('seller/ticket.price/index')}",
                    type:'post',
                    dataType:'json',
                    data:{ticket_id:"{$ticket['id']}",start:start,end:end},
                    success(res){
                        successCallback(res);
                    }
                })
            },
            eventContent: function(arg) {
                let info = arg.event._def.extendedProps;
                return {html: `线上价格：<b>￥${info.online_price}</b> <br>散客价格：<b>￥${info.casual_price}</b> <br>团体票价：<b>￥${info.team_price}</b> <br>总库存：<b>${info.total_stock} <br>剩余库存：<b>${info.stock}</b>`}
            },
            dateClick: function(info) {
                var today = new Date();
                if(info.date > today){
                    let date = formattedDate(info.date);
                    $.modal.open('修改日期价格',"{:url('seller/ticket.price/post')}" + "?ticket_id="+"{$ticket['id']}&_layer=1" + "&date="+date,600,500,function (index,res){
                        var formSubmit = layer.getChildFrame('form', index);
                        var submited = formSubmit.find('.form-builder-submit').find('button')[0];
                        submited.click();
                    });
                }
            }
        });
        calendar.render();
    });
    function formattedDate(dateObj){
        let year = dateObj.getFullYear();
        let month = ("0" + (dateObj.getMonth() + 1)).slice(-2);
        let day = ("0" + dateObj.getDate()).slice(-2);

        return year + "-" + month + "-" + day;
    }
    function reloads(){
        calendar.refetchEvents();
    }
</script>