# PHP → Python 全量重写可行性评估（停机 + 清库 + 接口 1:1 兼容）

## 结论

在你们给定的前提下（**允许长期停机**、**允许清库**、数据库可换 MySQL/PostgreSQL、管理端可用 React 重做，但**所有对外 HTTP 接口保持一致**），重构在技术上**可行**。  
真正的工作量与风险主要来自 **“接口契约 + 第三方对接 + 业务副作用一致性/幂等”**，而不是 PHP→Python 的语法迁移本身。

## 当前系统规模（静态扫描口径）

- 应用数：12（`api/admin/seller/travel/travelv2/window/selfservice/xc/meituan/index/mobile/handheld`）
- 对外接口骨架清单：840（见 `docs/rewrite/api-inventory.tsv`）
- P0（第三方回调/对接 + 小程序调用面）：193（见 `docs/rewrite/p0-interfaces.tsv`）
- 小程序（mp-native）实际调用：67（见 `docs/rewrite/miniapp-api-usage.tsv`，已确认 67/67 落在 P0）

> 备注：目前 `@api` 注释覆盖率很低（840 中仅少量明确了方法/路径），后续必须靠“契约补齐 + 回放/契约测试”把真实行为锁定。

## 影响可行性的关键约束（必须提前锁死）

1. **接口契约不变**：URL/HTTP Method/参数/必需 Header/返回字段结构与类型/错误码/第三方回调响应体必须 1:1。
2. **路径形态兼容**：ThinkPHP 使用 `url_html_suffix=html`，建议新系统同时兼容 `/{app}/{controller}/{action}` 与 `... .html`。
3. **鉴权与错误码兼容**：以 `api` 为例，Header `Token` + `Userid` 的校验与错误码（`110/111/112/113/115` 等）要保持一致（否则小程序会强制重新登录）。
4. **第三方回调 URL 形态要保持一致**（示例）：
   - 微信支付通知：`/api/notify/pay_async_notice/model/{Model}.html`
   - 退款通知：`/api/notify/refund/model/{Model}.html`
5. **OTA（携程/美团）签名/加密/响应码映射**：这类接口通常是“对接方验收标准”，必须按契约严格实现。

## 风险与工作量主要来源

- **隐式接口/动态路由**：仅靠静态扫描难以 100% 还原线上真实路径与行为，需要回放/契约测试兜底。
- **副作用一致性**：支付通知、退款、核销、库存扣减、发券、对账等往往涉及多表更新与幂等控制，是重写最容易“看似通了但账不对”的区域。
- **外部依赖**：微信支付/退款、OSS、短信/实名认证、OTA 等，错误码/超时/重试策略需要与旧系统一致或可解释地兼容。
- **上传接口多形态**：multipart 字段名、返回 URL 结构、大小/后缀限制、富文本编辑器上传兼容等。
- **后台入口兼容**：即便管理端换 React，也建议保持旧入口 URL 可访问（外部白名单/回调/收藏链接不变）。

## 推荐实施策略（符合“停机 + 清库”的最稳路线）

1. **契约先行**：每个对外接口补齐 `docs/rewrite/contract-template.md`，契约即验收标准。
2. **P0 先行**：先做第三方回调/对接 + 小程序 67 个接口 + 资金链路（见 `docs/rewrite/p0-backlog.md` 的 A0/A1/A2/B1）。
3. **先攻高风险边界**：支付/退款、OTA、上传、短信/实名认证，优先建立可重复的联调与回放用例。
4. **再补齐核心业务闭环与后台**：按“可用闭环”交付，不按“模块拆分”交付。
5. **清库也要可初始化**：把系统配置/支付配置/管理员账号等做成可重复的 seed 流程（避免“上线靠手工点配置”）。

## 技术栈建议（Python + React）

- 后端：FastAPI（路由清晰、性能好）+ Pydantic（入参/出参约束）+ SQLAlchemy + Alembic（迁移）
- 数据库：
  - **优先 MySQL**：仓库已有 `DDL_xfq_v2.sql`（明显是 MySQL 方言），能显著降低表结构与查询差异成本
  - PostgreSQL：可行，但要明确投入（DDL/SQL 差异、类型/索引差异）与收益
- Redis：缓存、分布式锁、限流、任务队列/会话
- 异步任务：Celery/Arq + 定时任务（替代 TP 的计划任务/脚本）
- 网关：Nginx/Traefik 负责 `.html` 兼容、统一域名与回调地址
- 管理端：React SPA（但尽量保持旧入口路径可访问，服务端统一返回 SPA index）

## 里程碑（经验估算，依团队与真实使用范围浮动很大）

- Phase 0（范围 + 契约/回放体系）：1–2 周
- Phase 1（底座：路由/envelope/鉴权/上传/配置/日志）：1–2 周
- Phase 2（P0 关键链路：支付/退款/OTA/短信/实名）：2–6 周
- Phase 3（业务域补齐 + React 后台）：4–8 周
- 全量 840 端点 1:1 兼容：通常 3–6+ 月（取决于“实际对外使用面”与团队规模）

## 建议立刻推进的下一步

- 以 `docs/rewrite/p0-backlog.md` 为第一批验收范围，先把 A0/A1/A2 的契约补齐并建立回放用例。
- 明确数据库选型（建议先 MySQL），并定义一键初始化（schema + seed）流程。
- 把“支付回调/退款回调/下单支付/退款申请/上传/短信/实名/OTA system+winlogin”等列为首批强验收接口（必须 1:1）。

