# Python 全量重写主计划（执行版）

更新时间：`2026-02-08`

## 1. 目标与边界

- 目标：将 PHP（ThinkPHP6）后端全量重写为 Python（FastAPI），并保持所有对外接口 1:1 兼容。
- 兼容范围：`/api`、`/window`、`/selfservice`、`/xc`、`/meituan` 全部对外入口。
- 硬约束：
  - URL / Method / 参数 / Header / 返回结构 / 错误码 / 副作用一致。
  - `.html` 路径与无后缀路径同时兼容。
  - 小程序前端不改造调用协议；外部第三方回调协议不变。
- 已接受前提：
  - 可长期停机直到重构完成。
  - 可清库（允许重置业务数据）。
  - 数据库可切换到 MySQL 或 PostgreSQL（当前执行基线先用 MySQL）。

## 2. 当前基线（可执行事实）

- `P0` 接口总数：`193`。
- 小程序实际调用接口：`67`。
- golden 覆盖：`193/193`（全覆盖）。
- Python 回放结果：
  - `make py-check-p0-dev`：`210` 用例通过。
  - `make py-check-p0-success-dev-reset`：`6` 成功路径用例通过。
- 当前风险：多数接口仍由 golden stub 承接，真实 Python 业务实现占比仍低。

## 3. 工作流与里程碑

### M0（已完成）：验收体系就绪

- 交付：
  - `p0-interfaces.tsv`、契约目录、golden 用例、回放脚本、DB reset 流程。
- Gate：
  - `py-check-p0-dev`、`py-check-p0-success-dev-reset` 全绿。

### M1：外部协议与资金链路先行（高风险域）

- 目标域：
  - OTA（`xc` / `meituan`）签名、验签、错误码。
  - 支付下单/退款/回调（含幂等与状态机）。
  - 上传、短信、实名（mock + 真环境切换）。
- 完成定义：
  - 以上接口从 stub 切换到真实 Python 实现。
  - golden 失败/成功路径全部通过。

### M2：小程序主业务闭环

- 目标域：
  - 用户、商户、门票、订单、核销、预约、消费券。
- 完成定义：
  - `67` 个小程序调用接口全部真实实现。
  - 每次 `db-reset-success + py-check-p0-success-dev-reset` 稳定通过。

### M3：剩余 P0 收口

- 目标域：
  - `window`、`selfservice`、系统任务及非小程序但仍对外接口。
- 完成定义：
  - `193` 个 P0 接口全部真实实现（无业务级 stub 依赖）。
  - 仅保留极少“不可避免兼容占位”（需在报告登记并说明原因）。

### M4：P1/P2 与运维可观测性补齐

- 目标域：
  - admin/seller/travel 等剩余应用；日志审计、告警、对账工具。
- 完成定义：
  - 回放基线扩展到 P1/P2。
  - 运维手册、故障演练、回退方案可执行。

### M5：上线 Gate 与切流

- 必达条件：
  - 全量回放通过。
  - 性能/稳定性达标。
  - 生产三方密钥和证书已配置并验证。
- 切流策略：
  - 停机维护窗口内一次性切换。
  - 保留只读回退窗口（必要时快速回退到静态维护页）。

## 4. 每接口完成标准（Definition of Done）

- 契约：存在且字段齐全（鉴权、参数、错误码、副作用、幂等）。
- 用例：
  - 至少 1 个失败路径 golden。
  - 写库接口至少 1 个成功路径 golden（放 `p0_success`）。
- 实现：
  - Python 明确路由实现，不依赖 catch-all stub。
  - `.html` 与无后缀都可访问。
- 验收：
  - 对应用例回放通过，且无新增差异。

## 5. 执行节奏（建议）

- 每日：
  - 先 `db-reset-*`，再跑局部与全量回放。
  - 提交接口级迁移状态（implemented/stub）。
- 每周：
  - 固定评审一次差异报告与风险清单。
  - 确认下一周接口批次（按 A0/A1/A2/B1/B2/C 分组）。
- 每里程碑：
  - 输出阶段报告（完成项、遗留项、风险、需确认决策）。

## 6. 风险与应对

- 风险：缺线上真实流量日志。
  - 应对：部署维护模式流量捕获，持续补齐差异路径。
- 风险：缺生产三方证书/参数。
  - 应对：先 mock 保证开发闭环；上线前作为强 Gate 阻断。
- 风险：行为兼容隐性差异（老代码历史兼容逻辑）。
  - 应对：以 golden + diff 回放为准绳，不凭主观“等价重写”。

## 7. 完成判定（项目终态）

满足以下全部条件才视为“重写完成”：

1. 所有对外接口均由 Python 真实实现承接（非 stub）。
2. 全量契约回放通过（P0/P1/P2）。
3. 清库后可一键初始化并通过完整回归。
4. 外部依赖（支付/OSS/短信/实名/OTA）真环境联调通过。
5. 交付完整运维文档与最终报告（含遗留/例外说明）。
